<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Custom expressions | Kotlin APIfor SMT solvers</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Custom expressions" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/custom-expressions.html" />
<meta property="og:url" content="http://localhost:4000/custom-expressions.html" />
<meta property="og:site_name" content="Kotlin APIfor SMT solvers" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Custom expressions" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","headline":"Custom expressions","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/img/ksmt-logo.jpg"}},"url":"http://localhost:4000/custom-expressions.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=b9a11fae826d74d0a5623369f08e20d938a3d82e">
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

</head>
<body>
<div class="wrapper">

    <header>

        
        <img src="/assets/img/ksmt-logo.jpg" alt="Logo" />
        

        <h1><a href="http://localhost:4000/">Kotlin API<br/>for SMT solvers</a></h1>

        <!--<h2>{"title"=>"Home", "url"=>"index.html"}{"title"=>"Getting started", "url"=>"getting-started.html"}{"title"=>"Advanced usage", "url"=>"advanced-usage.html"}{"title"=>"Custom expressions", "url"=>"custom-expressions.html"}</h2>-->
<ul>
    
    <li><a href="index.html">Home</a></li>
    
    <li><a href="getting-started.html">Getting started</a></li>
    
    <li><a href="advanced-usage.html">Advanced usage</a></li>
    
    <li><a href="custom-expressions.html">Custom expressions</a></li>
    
</ul>

<!--<ul>-->
<!--    -->
<!--    <li><a href="index.html">Home</a>-->
<!--        -->
<!--    </li>-->
<!--    -->
<!--    <li><a href="getting-started.html">Getting started</a>-->
<!--        -->
<!--    </li>-->
<!--    -->
<!--    <li><a href="advanced-usage.html">Advanced usage</a>-->
<!--        -->
<!--    </li>-->
<!--    -->
<!--    <li><a href="custom-expressions.html">Custom expressions</a>-->
<!--        -->
<!--    </li>-->
<!--    -->
<!--</ul>-->


        <p></p>

<!--        -->
<!--        <p class="view"><a href="https://github.com/olganaumenko/pseudoksmt">View the Project on GitHub <small>olganaumenko/pseudoksmt</small></a></p>-->
<!--        -->



<!--        -->

<!--        -->
    </header>
    <section>

<!--        <h1 id="usage-scenario-custom-expressions">Usage scenario: custom expressions</h1>

<p>To extend the KSMT expression system with the user-defined expressions, try 
<a href="https://github.com/UnitTestBot/ksmt/tree/main/examples/src/main/kotlin/CustomExpressions.kt">custom expression example</a> and follow the scenarios below.</p>

<h2 id="defining-expressions">Defining expressions</h2>

<p>As an example, we consider the following expression structure:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">CustomExpr</code> — a base expression;</li>
  <li><code class="language-plaintext highlighter-rouge">CustomAndExpr</code> — a custom expression that acts like <code class="language-plaintext highlighter-rouge">n-ary logical and</code>;</li>
  <li><code class="language-plaintext highlighter-rouge">CustomBvAddExpr</code> — a custom expression that acts like <code class="language-plaintext highlighter-rouge">n-ary bvadd</code>.</li>
</ul>

<h3 id="base-expression-and-transformer">Base expression and transformer</h3>

<p>We must not only define the new custom expression but also define an extended <code class="language-plaintext highlighter-rouge">KTransformer</code>, because KSMT 
transformers are unaware of our custom expressions.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">CustomTransformer</span> <span class="p">:</span> <span class="nc">KTransformer</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">transform</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nc">CustomAndExpr</span><span class="p">):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;</span>
    <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">KBvSort</span><span class="p">&gt;</span> <span class="nf">transform</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nc">CustomBvAddExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For the base expression, we override the <code class="language-plaintext highlighter-rouge">accept</code> function with our <code class="language-plaintext highlighter-rouge">CustomTransformer</code>, 
since all our custom expressions can only be correctly transformed with this transformer.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">abstract</span> <span class="kd">class</span> <span class="nc">CustomExpr</span><span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">KSort</span><span class="p">&gt;(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">KContext</span><span class="p">)</span> <span class="p">:</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">accept</span><span class="p">(</span><span class="n">transformer</span><span class="p">:</span> <span class="nc">KTransformerBase</span><span class="p">):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="cm">/**
         * Since KSMT transformers are unaware of our custom expressions
         * we must use our own extended transformer.
         *
         * Note: it is a good idea to throw an exception when our
         * custom expression is visited by the other transformer,
         * because this usually means that our custom expression
         * has leaked into the KSMT core and will be processed incorrectly.
         * */</span>
        <span class="n">transformer</span> <span class="k">as</span><span class="p">?</span> <span class="nc">CustomTransformer</span> <span class="o">?:</span> <span class="nf">error</span><span class="p">(</span><span class="s">"Leaked custom expression"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">accept</span><span class="p">(</span><span class="n">transformer</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">abstract</span> <span class="k">fun</span> <span class="nf">accept</span><span class="p">(</span><span class="n">transformer</span><span class="p">:</span> <span class="nc">CustomTransformer</span><span class="p">):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="defining-a-custom-expression">Defining a custom expression</h3>

<p>Important notes on defining custom expressions are provided as comments in the examples.
See <a href="#expression-management">expression management</a> for details about <code class="language-plaintext highlighter-rouge">equals</code>, <code class="language-plaintext highlighter-rouge">hashCode</code>, 
<code class="language-plaintext highlighter-rouge">internEquals</code>, and <code class="language-plaintext highlighter-rouge">internHashCode</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">CustomAndExpr</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">args</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;&gt;,</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="nc">KContext</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">CustomExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">override</span> <span class="kd">val</span> <span class="py">sort</span><span class="p">:</span> <span class="nc">KBoolSort</span>
        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">boolSort</span>

    <span class="cm">/**
     * Expression printer, suitable for deeply nested expressions.
     * Mainly used in `toString`.
     * */</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">print</span><span class="p">(</span><span class="n">printer</span><span class="p">:</span> <span class="nc">ExpressionPrinter</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s">"(customAnd"</span><span class="p">)</span>
        <span class="n">args</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span>
            <span class="n">printer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s">" "</span><span class="p">)</span>

            <span class="cm">/**
             * Note the use of `append` with `KExpr` argument.
             * */</span>
            <span class="n">printer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">printer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s">")"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="cm">/**
     * Analogues of `equals` and `hashCode`.
     * */</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">internHashCode</span><span class="p">():</span> <span class="nc">Int</span> <span class="p">=</span> <span class="nf">hash</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="cm">/**
     * Note the `structurallyEqual` utility checking
     * if types are the same and all the fields specified in `{ }` are equal.
     * */</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">internEquals</span><span class="p">(</span><span class="n">other</span><span class="p">:</span> <span class="nc">Any</span><span class="p">):</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="nf">structurallyEqual</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span> <span class="n">args</span> <span class="p">}</span>

    <span class="cm">/**
     * The expression is visited by the transformer.
     * Normally, we invoke the corresponding `transform`
     * method of the transformer and return the invocation result.
     *
     * It is usually a bad idea to return something without `transform`
     * invocation, or to invoke `transform` on some other expression.
     * It is better to perform any expression transformation with the
     * corresponding transformer.
     * */</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">accept</span><span class="p">(</span><span class="n">transformer</span><span class="p">:</span> <span class="nc">CustomTransformer</span><span class="p">):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;</span> <span class="p">=</span>
        <span class="n">transformer</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The definition of <code class="language-plaintext highlighter-rouge">CustomBvAddExpr</code> is actually the same as for <code class="language-plaintext highlighter-rouge">CustomAndExpr</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">CustomBvAddExpr</span><span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">KBvSort</span><span class="p">&gt;(</span>
    <span class="kd">val</span> <span class="py">args</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;&gt;,</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="nc">KContext</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">CustomExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>

    <span class="cm">/**
     * The sort of this expression is parametric and
     * depends on the sorts of arguments.
     * */</span>
    <span class="k">override</span> <span class="kd">val</span> <span class="py">sort</span><span class="p">:</span> <span class="nc">T</span> <span class="k">by</span> <span class="nf">lazy</span> <span class="p">{</span> <span class="n">args</span><span class="p">.</span><span class="nf">first</span><span class="p">().</span><span class="n">sort</span> <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">print</span><span class="p">(</span><span class="n">printer</span><span class="p">:</span> <span class="nc">ExpressionPrinter</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s">"(customBvAdd"</span><span class="p">)</span>
        <span class="n">args</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span>
            <span class="n">printer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s">" "</span><span class="p">)</span>
            <span class="n">printer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">printer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s">")"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">internHashCode</span><span class="p">():</span> <span class="nc">Int</span> <span class="p">=</span> <span class="nf">hash</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">internEquals</span><span class="p">(</span><span class="n">other</span><span class="p">:</span> <span class="nc">Any</span><span class="p">):</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="nf">structurallyEqual</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span> <span class="n">args</span> <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">accept</span><span class="p">(</span><span class="n">transformer</span><span class="p">:</span> <span class="nc">CustomTransformer</span><span class="p">):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="p">=</span>
        <span class="n">transformer</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="rewriting-expressions">Rewriting expressions</h2>

<p>Since KSMT is unaware of custom expressions, we must ensure that the expressions to be processed 
by the KSMT facilities do not contain custom parts.
Regarding this, we define a transformer for the custom expressions that rewrites 
them with the appropriate KSMT expressions.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">CustomExprRewriter</span><span class="p">(</span>
    <span class="k">override</span> <span class="kd">val</span> <span class="py">ctx</span><span class="p">:</span> <span class="nc">KContext</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">KNonRecursiveTransformer</span><span class="p">(</span><span class="n">ctx</span><span class="p">),</span> <span class="nc">CustomTransformer</span> <span class="p">{</span>
    <span class="cm">/**
     * Here we use `transformExprAfterTransformed` function of `KNonRecursiveTransformer`
     * that implements bottom-up transformation (transform arguments first).
     * */</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">KBvSort</span><span class="p">&gt;</span> <span class="nf">transform</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nc">CustomBvAddExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="p">=</span>
        <span class="nf">transformExprAfterTransformed</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">expr</span><span class="p">.</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span> <span class="n">transformedArgs</span> <span class="p">-&gt;</span>
            <span class="n">transformedArgs</span><span class="p">.</span><span class="nf">reduce</span> <span class="p">{</span> <span class="n">acc</span><span class="p">,</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="n">ctx</span><span class="p">.</span><span class="nf">mkBvAddExpr</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">transform</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nc">CustomAndExpr</span><span class="p">):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;</span> <span class="p">=</span>
        <span class="nf">transformExprAfterTransformed</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">expr</span><span class="p">.</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span> <span class="n">transformedArgs</span> <span class="p">-&gt;</span>
            <span class="n">ctx</span><span class="p">.</span><span class="nf">mkAnd</span><span class="p">(</span><span class="n">transformedArgs</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Note the <code class="language-plaintext highlighter-rouge">KNonRecursiveTransformer</code> that allows transformation of deeply nested expressions without recursion.</p>

<h2 id="managing-expressions">Managing expressions</h2>

<p>In KSMT, we use expression interning and guarantee that two of equal expressions are <em>equal by reference</em> (i.e., are 
the same object).</p>

<p>We use <code class="language-plaintext highlighter-rouge">internEquals</code> and <code class="language-plaintext highlighter-rouge">internHashCode</code> to replace <code class="language-plaintext highlighter-rouge">equals</code> and <code class="language-plaintext highlighter-rouge">hashCode</code>,
and we use <em>reference equality</em> for the <code class="language-plaintext highlighter-rouge">equals</code> method.</p>

<p>To apply interning for custom expressions, you need to create an <em>interner</em> and ensure that it manages all the created 
expressions. For this purpose, it is convenient to define an extended context that manages all custom expressions.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">CustomContext</span> <span class="p">:</span> <span class="nc">KContext</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Interners for custom expressions.</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">customAndInterner</span> <span class="p">=</span> <span class="n">mkAstInterner</span><span class="p">&lt;</span><span class="nc">CustomAndExpr</span><span class="p">&gt;()</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">customBvInterner</span> <span class="p">=</span> <span class="n">mkAstInterner</span><span class="p">&lt;</span><span class="nc">CustomBvAddExpr</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;&gt;()</span>

    <span class="c1">// Expression builder that performs interning of a created expression</span>
    <span class="k">fun</span> <span class="nf">mkCustomAnd</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;&gt;):</span> <span class="nc">CustomAndExpr</span> <span class="p">=</span>
        <span class="n">customAndInterner</span><span class="p">.</span><span class="nf">createIfContextActive</span> <span class="p">{</span>
            <span class="nc">CustomAndExpr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">KBvSort</span><span class="p">&gt;</span> <span class="nf">mkCustomBvAdd</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;&gt;):</span> <span class="nc">CustomBvAddExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="p">=</span>
        <span class="n">customBvInterner</span><span class="p">.</span><span class="nf">createIfContextActive</span> <span class="p">{</span>
            <span class="nc">CustomBvAddExpr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
        <span class="p">}.</span><span class="nf">uncheckedCast</span><span class="p">()</span> <span class="c1">// Unchecked cast is used here because 'customBvInterner' has erased sort.</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="misc-wrappers">Misc: wrappers</h2>

<p>Since it is required to eliminate all the custom expressions before interacting with any KSMT feature, 
it is convenient to create wrappers.</p>

<p>For example, we can wrap <code class="language-plaintext highlighter-rouge">KSolver</code> and eliminate custom expressions on each query.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">CustomSolver</span><span class="p">&lt;</span><span class="nc">C</span> <span class="p">:</span> <span class="nc">KSolverConfiguration</span><span class="p">&gt;(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">solver</span><span class="p">:</span> <span class="nc">KSolver</span><span class="p">&lt;</span><span class="nc">C</span><span class="p">&gt;,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">transformer</span><span class="p">:</span> <span class="nc">CustomExprRewriter</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">KSolver</span><span class="p">&lt;</span><span class="nc">C</span><span class="p">&gt;</span> <span class="p">{</span>

    <span class="c1">// `expr` can contain custom expressions -&gt; rewrite</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">assert</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;)</span> <span class="p">=</span>
        <span class="n">solver</span><span class="p">.</span><span class="nf">assert</span><span class="p">(</span><span class="n">transformer</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>

    <span class="c1">// `expr` can contain custom expressions -&gt; rewrite</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">assertAndTrack</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;)</span> <span class="p">=</span>
        <span class="n">solver</span><span class="p">.</span><span class="nf">assertAndTrack</span><span class="p">(</span><span class="n">transformer</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>

    <span class="c1">// `assumptions` can contain custom expressions -&gt; rewrite</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">checkWithAssumptions</span><span class="p">(</span><span class="n">assumptions</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;&gt;,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nc">Duration</span><span class="p">):</span> <span class="nc">KSolverStatus</span> <span class="p">=</span>
        <span class="n">solver</span><span class="p">.</span><span class="nf">checkWithAssumptions</span><span class="p">(</span><span class="n">assumptions</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">transformer</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">},</span> <span class="n">timeout</span><span class="p">)</span>

    <span class="c1">// wrap model for correct `eval` method handling</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">model</span><span class="p">():</span> <span class="nc">KModel</span> <span class="p">=</span> <span class="nc">CustomModel</span><span class="p">(</span><span class="n">solver</span><span class="p">.</span><span class="nf">model</span><span class="p">(),</span> <span class="n">transformer</span><span class="p">)</span>

    <span class="c1">// Other methods do not suffer from custom expressions</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">check</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="nc">Duration</span><span class="p">):</span> <span class="nc">KSolverStatus</span> <span class="p">=</span>
        <span class="n">solver</span><span class="p">.</span><span class="nf">check</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">pop</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nc">UInt</span><span class="p">)</span> <span class="p">=</span> <span class="n">solver</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">push</span><span class="p">()</span> <span class="p">=</span> <span class="n">solver</span><span class="p">.</span><span class="nf">push</span><span class="p">()</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">reasonOfUnknown</span><span class="p">():</span> <span class="nc">String</span> <span class="p">=</span> <span class="n">solver</span><span class="p">.</span><span class="nf">reasonOfUnknown</span><span class="p">()</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">unsatCore</span><span class="p">():</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;&gt;</span> <span class="p">=</span> <span class="n">solver</span><span class="p">.</span><span class="nf">unsatCore</span><span class="p">()</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">close</span><span class="p">()</span> <span class="p">=</span> <span class="n">solver</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">configure</span><span class="p">(</span><span class="n">configurator</span><span class="p">:</span> <span class="nc">C</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="nc">Unit</span><span class="p">)</span> <span class="p">=</span> <span class="n">solver</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="n">configurator</span><span class="p">)</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">interrupt</span><span class="p">()</span> <span class="p">=</span> <span class="n">solver</span><span class="p">.</span><span class="nf">interrupt</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can wrap <code class="language-plaintext highlighter-rouge">KModel</code> and eliminate custom expressions before <code class="language-plaintext highlighter-rouge">eval</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">CustomModel</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">model</span><span class="p">:</span> <span class="nc">KModel</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">transformer</span><span class="p">:</span> <span class="nc">CustomExprRewriter</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">KModel</span> <span class="p">{</span>
    <span class="c1">// `expr` can contain custom expressions -&gt; rewrite</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">KSort</span><span class="p">&gt;</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;,</span> <span class="n">isComplete</span><span class="p">:</span> <span class="nc">Boolean</span><span class="p">):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="p">=</span>
        <span class="n">model</span><span class="p">.</span><span class="nf">eval</span><span class="p">(</span><span class="n">transformer</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span> <span class="n">isComplete</span><span class="p">)</span>

    <span class="c1">// Other methods do not suffer from custom expressions</span>

    <span class="k">override</span> <span class="kd">val</span> <span class="py">declarations</span><span class="p">:</span> <span class="nc">Set</span><span class="p">&lt;</span><span class="nc">KDecl</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;&gt;</span>
        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">declarations</span>

    <span class="k">override</span> <span class="kd">val</span> <span class="py">uninterpretedSorts</span><span class="p">:</span> <span class="nc">Set</span><span class="p">&lt;</span><span class="nc">KUninterpretedSort</span><span class="p">&gt;</span>
        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">uninterpretedSorts</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">KSort</span><span class="p">&gt;</span> <span class="nf">interpretation</span><span class="p">(</span><span class="n">decl</span><span class="p">:</span> <span class="nc">KDecl</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;):</span> <span class="nc">KFuncInterp</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;?</span> <span class="p">=</span>
        <span class="n">model</span><span class="p">.</span><span class="nf">interpretation</span><span class="p">(</span><span class="n">decl</span><span class="p">)</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">uninterpretedSortUniverse</span><span class="p">(</span><span class="n">sort</span><span class="p">:</span> <span class="nc">KUninterpretedSort</span><span class="p">):</span> <span class="nc">Set</span><span class="p">&lt;</span><span class="nc">KUninterpretedSortValue</span><span class="p">&gt;?</span> <span class="p">=</span>
        <span class="n">model</span><span class="p">.</span><span class="nf">uninterpretedSortUniverse</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">detach</span><span class="p">():</span> <span class="nc">KModel</span> <span class="p">=</span> <span class="nc">CustomModel</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">detach</span><span class="p">(),</span> <span class="n">transformer</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
-->
        <h1 id="usage-scenario-custom-expressions">
  
  
    Usage scenario: custom expressions <a href="#usage-scenario-custom-expressions">#</a>
  
  
</h1>
    

<p>To extend the KSMT expression system with the user-defined expressions, try 
<a href="https://github.com/UnitTestBot/ksmt/tree/main/examples/src/main/kotlin/CustomExpressions.kt">custom expression example</a> and follow the scenarios below.</p>
<h2 id="defining-expressions">
  
  
    Defining expressions <a href="#defining-expressions">#</a>
  
  
</h2>
    

<p>As an example, we consider the following expression structure:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">CustomExpr</code> — a base expression;</li>
  <li><code class="language-plaintext highlighter-rouge">CustomAndExpr</code> — a custom expression that acts like <code class="language-plaintext highlighter-rouge">n-ary logical and</code>;</li>
  <li><code class="language-plaintext highlighter-rouge">CustomBvAddExpr</code> — a custom expression that acts like <code class="language-plaintext highlighter-rouge">n-ary bvadd</code>.</li>
</ul>
<h3 id="base-expression-and-transformer">
  
  
    Base expression and transformer <a href="#base-expression-and-transformer">#</a>
  
  
</h3>
    

<p>We must not only define the new custom expression but also define an extended <code class="language-plaintext highlighter-rouge">KTransformer</code>, because KSMT 
transformers are unaware of our custom expressions.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">CustomTransformer</span> <span class="p">:</span> <span class="nc">KTransformer</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">transform</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nc">CustomAndExpr</span><span class="p">):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;</span>
    <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">KBvSort</span><span class="p">&gt;</span> <span class="nf">transform</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nc">CustomBvAddExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For the base expression, we override the <code class="language-plaintext highlighter-rouge">accept</code> function with our <code class="language-plaintext highlighter-rouge">CustomTransformer</code>, 
since all our custom expressions can only be correctly transformed with this transformer.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">abstract</span> <span class="kd">class</span> <span class="nc">CustomExpr</span><span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">KSort</span><span class="p">&gt;(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">KContext</span><span class="p">)</span> <span class="p">:</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">accept</span><span class="p">(</span><span class="n">transformer</span><span class="p">:</span> <span class="nc">KTransformerBase</span><span class="p">):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="cm">/**
         * Since KSMT transformers are unaware of our custom expressions
         * we must use our own extended transformer.
         *
         * Note: it is a good idea to throw an exception when our
         * custom expression is visited by the other transformer,
         * because this usually means that our custom expression
         * has leaked into the KSMT core and will be processed incorrectly.
         * */</span>
        <span class="n">transformer</span> <span class="k">as</span><span class="p">?</span> <span class="nc">CustomTransformer</span> <span class="o">?:</span> <span class="nf">error</span><span class="p">(</span><span class="s">"Leaked custom expression"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">accept</span><span class="p">(</span><span class="n">transformer</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">abstract</span> <span class="k">fun</span> <span class="nf">accept</span><span class="p">(</span><span class="n">transformer</span><span class="p">:</span> <span class="nc">CustomTransformer</span><span class="p">):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span>
<span class="p">}</span>
</code></pre></div></div>
<h3 id="defining-a-custom-expression">
  
  
    Defining a custom expression <a href="#defining-a-custom-expression">#</a>
  
  
</h3>
    

<p>Important notes on defining custom expressions are provided as comments in the examples.
See <a href="#expression-management">expression management</a> for details about <code class="language-plaintext highlighter-rouge">equals</code>, <code class="language-plaintext highlighter-rouge">hashCode</code>, 
<code class="language-plaintext highlighter-rouge">internEquals</code>, and <code class="language-plaintext highlighter-rouge">internHashCode</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">CustomAndExpr</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">args</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;&gt;,</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="nc">KContext</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">CustomExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">override</span> <span class="kd">val</span> <span class="py">sort</span><span class="p">:</span> <span class="nc">KBoolSort</span>
        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">boolSort</span>

    <span class="cm">/**
     * Expression printer, suitable for deeply nested expressions.
     * Mainly used in `toString`.
     * */</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">print</span><span class="p">(</span><span class="n">printer</span><span class="p">:</span> <span class="nc">ExpressionPrinter</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s">"(customAnd"</span><span class="p">)</span>
        <span class="n">args</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span>
            <span class="n">printer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s">" "</span><span class="p">)</span>

            <span class="cm">/**
             * Note the use of `append` with `KExpr` argument.
             * */</span>
            <span class="n">printer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">printer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s">")"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="cm">/**
     * Analogues of `equals` and `hashCode`.
     * */</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">internHashCode</span><span class="p">():</span> <span class="nc">Int</span> <span class="p">=</span> <span class="nf">hash</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="cm">/**
     * Note the `structurallyEqual` utility checking
     * if types are the same and all the fields specified in `{ }` are equal.
     * */</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">internEquals</span><span class="p">(</span><span class="n">other</span><span class="p">:</span> <span class="nc">Any</span><span class="p">):</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="nf">structurallyEqual</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span> <span class="n">args</span> <span class="p">}</span>

    <span class="cm">/**
     * The expression is visited by the transformer.
     * Normally, we invoke the corresponding `transform`
     * method of the transformer and return the invocation result.
     *
     * It is usually a bad idea to return something without `transform`
     * invocation, or to invoke `transform` on some other expression.
     * It is better to perform any expression transformation with the
     * corresponding transformer.
     * */</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">accept</span><span class="p">(</span><span class="n">transformer</span><span class="p">:</span> <span class="nc">CustomTransformer</span><span class="p">):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;</span> <span class="p">=</span>
        <span class="n">transformer</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The definition of <code class="language-plaintext highlighter-rouge">CustomBvAddExpr</code> is actually the same as for <code class="language-plaintext highlighter-rouge">CustomAndExpr</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">CustomBvAddExpr</span><span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">KBvSort</span><span class="p">&gt;(</span>
    <span class="kd">val</span> <span class="py">args</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;&gt;,</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="nc">KContext</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">CustomExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>

    <span class="cm">/**
     * The sort of this expression is parametric and
     * depends on the sorts of arguments.
     * */</span>
    <span class="k">override</span> <span class="kd">val</span> <span class="py">sort</span><span class="p">:</span> <span class="nc">T</span> <span class="k">by</span> <span class="nf">lazy</span> <span class="p">{</span> <span class="n">args</span><span class="p">.</span><span class="nf">first</span><span class="p">().</span><span class="n">sort</span> <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">print</span><span class="p">(</span><span class="n">printer</span><span class="p">:</span> <span class="nc">ExpressionPrinter</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s">"(customBvAdd"</span><span class="p">)</span>
        <span class="n">args</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span>
            <span class="n">printer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s">" "</span><span class="p">)</span>
            <span class="n">printer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">printer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s">")"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">internHashCode</span><span class="p">():</span> <span class="nc">Int</span> <span class="p">=</span> <span class="nf">hash</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">internEquals</span><span class="p">(</span><span class="n">other</span><span class="p">:</span> <span class="nc">Any</span><span class="p">):</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="nf">structurallyEqual</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span> <span class="n">args</span> <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">accept</span><span class="p">(</span><span class="n">transformer</span><span class="p">:</span> <span class="nc">CustomTransformer</span><span class="p">):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="p">=</span>
        <span class="n">transformer</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<h2 id="rewriting-expressions">
  
  
    Rewriting expressions <a href="#rewriting-expressions">#</a>
  
  
</h2>
    

<p>Since KSMT is unaware of custom expressions, we must ensure that the expressions to be processed 
by the KSMT facilities do not contain custom parts.
Regarding this, we define a transformer for the custom expressions that rewrites 
them with the appropriate KSMT expressions.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">CustomExprRewriter</span><span class="p">(</span>
    <span class="k">override</span> <span class="kd">val</span> <span class="py">ctx</span><span class="p">:</span> <span class="nc">KContext</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">KNonRecursiveTransformer</span><span class="p">(</span><span class="n">ctx</span><span class="p">),</span> <span class="nc">CustomTransformer</span> <span class="p">{</span>
    <span class="cm">/**
     * Here we use `transformExprAfterTransformed` function of `KNonRecursiveTransformer`
     * that implements bottom-up transformation (transform arguments first).
     * */</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">KBvSort</span><span class="p">&gt;</span> <span class="nf">transform</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nc">CustomBvAddExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="p">=</span>
        <span class="nf">transformExprAfterTransformed</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">expr</span><span class="p">.</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span> <span class="n">transformedArgs</span> <span class="p">-&gt;</span>
            <span class="n">transformedArgs</span><span class="p">.</span><span class="nf">reduce</span> <span class="p">{</span> <span class="n">acc</span><span class="p">,</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="n">ctx</span><span class="p">.</span><span class="nf">mkBvAddExpr</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">transform</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nc">CustomAndExpr</span><span class="p">):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;</span> <span class="p">=</span>
        <span class="nf">transformExprAfterTransformed</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">expr</span><span class="p">.</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span> <span class="n">transformedArgs</span> <span class="p">-&gt;</span>
            <span class="n">ctx</span><span class="p">.</span><span class="nf">mkAnd</span><span class="p">(</span><span class="n">transformedArgs</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Note the <code class="language-plaintext highlighter-rouge">KNonRecursiveTransformer</code> that allows transformation of deeply nested expressions without recursion.</p>
<h2 id="managing-expressions">
  
  
    Managing expressions <a href="#managing-expressions">#</a>
  
  
</h2>
    

<p>In KSMT, we use expression interning and guarantee that two of equal expressions are <em>equal by reference</em> (i.e., are 
the same object).</p>

<p>We use <code class="language-plaintext highlighter-rouge">internEquals</code> and <code class="language-plaintext highlighter-rouge">internHashCode</code> to replace <code class="language-plaintext highlighter-rouge">equals</code> and <code class="language-plaintext highlighter-rouge">hashCode</code>,
and we use <em>reference equality</em> for the <code class="language-plaintext highlighter-rouge">equals</code> method.</p>

<p>To apply interning for custom expressions, you need to create an <em>interner</em> and ensure that it manages all the created 
expressions. For this purpose, it is convenient to define an extended context that manages all custom expressions.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">CustomContext</span> <span class="p">:</span> <span class="nc">KContext</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Interners for custom expressions.</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">customAndInterner</span> <span class="p">=</span> <span class="n">mkAstInterner</span><span class="p">&lt;</span><span class="nc">CustomAndExpr</span><span class="p">&gt;()</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">customBvInterner</span> <span class="p">=</span> <span class="n">mkAstInterner</span><span class="p">&lt;</span><span class="nc">CustomBvAddExpr</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;&gt;()</span>

    <span class="c1">// Expression builder that performs interning of a created expression</span>
    <span class="k">fun</span> <span class="nf">mkCustomAnd</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;&gt;):</span> <span class="nc">CustomAndExpr</span> <span class="p">=</span>
        <span class="n">customAndInterner</span><span class="p">.</span><span class="nf">createIfContextActive</span> <span class="p">{</span>
            <span class="nc">CustomAndExpr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">KBvSort</span><span class="p">&gt;</span> <span class="nf">mkCustomBvAdd</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;&gt;):</span> <span class="nc">CustomBvAddExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="p">=</span>
        <span class="n">customBvInterner</span><span class="p">.</span><span class="nf">createIfContextActive</span> <span class="p">{</span>
            <span class="nc">CustomBvAddExpr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
        <span class="p">}.</span><span class="nf">uncheckedCast</span><span class="p">()</span> <span class="c1">// Unchecked cast is used here because 'customBvInterner' has erased sort.</span>
<span class="p">}</span>
</code></pre></div></div>
<h2 id="misc-wrappers">
  
  
    Misc: wrappers <a href="#misc-wrappers">#</a>
  
  
</h2>
    

<p>Since it is required to eliminate all the custom expressions before interacting with any KSMT feature, 
it is convenient to create wrappers.</p>

<p>For example, we can wrap <code class="language-plaintext highlighter-rouge">KSolver</code> and eliminate custom expressions on each query.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">CustomSolver</span><span class="p">&lt;</span><span class="nc">C</span> <span class="p">:</span> <span class="nc">KSolverConfiguration</span><span class="p">&gt;(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">solver</span><span class="p">:</span> <span class="nc">KSolver</span><span class="p">&lt;</span><span class="nc">C</span><span class="p">&gt;,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">transformer</span><span class="p">:</span> <span class="nc">CustomExprRewriter</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">KSolver</span><span class="p">&lt;</span><span class="nc">C</span><span class="p">&gt;</span> <span class="p">{</span>

    <span class="c1">// `expr` can contain custom expressions -&gt; rewrite</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">assert</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;)</span> <span class="p">=</span>
        <span class="n">solver</span><span class="p">.</span><span class="nf">assert</span><span class="p">(</span><span class="n">transformer</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>

    <span class="c1">// `expr` can contain custom expressions -&gt; rewrite</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">assertAndTrack</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;)</span> <span class="p">=</span>
        <span class="n">solver</span><span class="p">.</span><span class="nf">assertAndTrack</span><span class="p">(</span><span class="n">transformer</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>

    <span class="c1">// `assumptions` can contain custom expressions -&gt; rewrite</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">checkWithAssumptions</span><span class="p">(</span><span class="n">assumptions</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;&gt;,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nc">Duration</span><span class="p">):</span> <span class="nc">KSolverStatus</span> <span class="p">=</span>
        <span class="n">solver</span><span class="p">.</span><span class="nf">checkWithAssumptions</span><span class="p">(</span><span class="n">assumptions</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">transformer</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">},</span> <span class="n">timeout</span><span class="p">)</span>

    <span class="c1">// wrap model for correct `eval` method handling</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">model</span><span class="p">():</span> <span class="nc">KModel</span> <span class="p">=</span> <span class="nc">CustomModel</span><span class="p">(</span><span class="n">solver</span><span class="p">.</span><span class="nf">model</span><span class="p">(),</span> <span class="n">transformer</span><span class="p">)</span>

    <span class="c1">// Other methods do not suffer from custom expressions</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">check</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="nc">Duration</span><span class="p">):</span> <span class="nc">KSolverStatus</span> <span class="p">=</span>
        <span class="n">solver</span><span class="p">.</span><span class="nf">check</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">pop</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nc">UInt</span><span class="p">)</span> <span class="p">=</span> <span class="n">solver</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">push</span><span class="p">()</span> <span class="p">=</span> <span class="n">solver</span><span class="p">.</span><span class="nf">push</span><span class="p">()</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">reasonOfUnknown</span><span class="p">():</span> <span class="nc">String</span> <span class="p">=</span> <span class="n">solver</span><span class="p">.</span><span class="nf">reasonOfUnknown</span><span class="p">()</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">unsatCore</span><span class="p">():</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">KBoolSort</span><span class="p">&gt;&gt;</span> <span class="p">=</span> <span class="n">solver</span><span class="p">.</span><span class="nf">unsatCore</span><span class="p">()</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">close</span><span class="p">()</span> <span class="p">=</span> <span class="n">solver</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">configure</span><span class="p">(</span><span class="n">configurator</span><span class="p">:</span> <span class="nc">C</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="nc">Unit</span><span class="p">)</span> <span class="p">=</span> <span class="n">solver</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="n">configurator</span><span class="p">)</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">interrupt</span><span class="p">()</span> <span class="p">=</span> <span class="n">solver</span><span class="p">.</span><span class="nf">interrupt</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can wrap <code class="language-plaintext highlighter-rouge">KModel</code> and eliminate custom expressions before <code class="language-plaintext highlighter-rouge">eval</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">CustomModel</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">model</span><span class="p">:</span> <span class="nc">KModel</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">transformer</span><span class="p">:</span> <span class="nc">CustomExprRewriter</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">KModel</span> <span class="p">{</span>
    <span class="c1">// `expr` can contain custom expressions -&gt; rewrite</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">KSort</span><span class="p">&gt;</span> <span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;,</span> <span class="n">isComplete</span><span class="p">:</span> <span class="nc">Boolean</span><span class="p">):</span> <span class="nc">KExpr</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="p">=</span>
        <span class="n">model</span><span class="p">.</span><span class="nf">eval</span><span class="p">(</span><span class="n">transformer</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span> <span class="n">isComplete</span><span class="p">)</span>

    <span class="c1">// Other methods do not suffer from custom expressions</span>

    <span class="k">override</span> <span class="kd">val</span> <span class="py">declarations</span><span class="p">:</span> <span class="nc">Set</span><span class="p">&lt;</span><span class="nc">KDecl</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;&gt;</span>
        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">declarations</span>

    <span class="k">override</span> <span class="kd">val</span> <span class="py">uninterpretedSorts</span><span class="p">:</span> <span class="nc">Set</span><span class="p">&lt;</span><span class="nc">KUninterpretedSort</span><span class="p">&gt;</span>
        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">uninterpretedSorts</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">KSort</span><span class="p">&gt;</span> <span class="nf">interpretation</span><span class="p">(</span><span class="n">decl</span><span class="p">:</span> <span class="nc">KDecl</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;):</span> <span class="nc">KFuncInterp</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;?</span> <span class="p">=</span>
        <span class="n">model</span><span class="p">.</span><span class="nf">interpretation</span><span class="p">(</span><span class="n">decl</span><span class="p">)</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">uninterpretedSortUniverse</span><span class="p">(</span><span class="n">sort</span><span class="p">:</span> <span class="nc">KUninterpretedSort</span><span class="p">):</span> <span class="nc">Set</span><span class="p">&lt;</span><span class="nc">KUninterpretedSortValue</span><span class="p">&gt;?</span> <span class="p">=</span>
        <span class="n">model</span><span class="p">.</span><span class="nf">uninterpretedSortUniverse</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">detach</span><span class="p">():</span> <span class="nc">KModel</span> <span class="p">=</span> <span class="nc">CustomModel</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">detach</span><span class="p">(),</span> <span class="n">transformer</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>



    </section>
<!--    <footer>-->
<!--        -->
<!--        <p>This project is maintained by <a href="https://github.com/olganaumenko">olganaumenko</a></p>-->
<!--        -->
<!--        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>-->
<!--    </footer>-->
</div>
<script src="/assets/js/scale.fix.js"></script>
</body>
</html>